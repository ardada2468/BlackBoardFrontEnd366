{"version":3,"sources":["../../source/server/render.js"],"names":["React","ReactDOM","createStringStream","MultiStream","renderBeforeContent","renderAfterContent","normalizeSettings","timer","getLocationUrl","parseLocation","reduxRender","initialize","reduxInitialize","generateMetaTagsMarkup","mergeMeta","convertOpenGraphLocaleToLanguageTag","settings","generateOuterHtml","meta","head","html","bodyStart","bodyEnd","path","parameters","assets","entries","javascript","main","Error","beforeContent","locale","join","afterContent","generateJavascript","locales","serverSideRender","contentNotRendered","renderContent","proxy","url","cookies","headers","getInitialState","routes","container","defaultMeta","authentication","onError","codeSplit","location","pathname","replace","render","newCookies","route","status","content","redirect","containerProps","time","basename","streams","pageElement","createElement","splice","length","renderToNodeStream"],"mappings":";;;;;;;;;;AAAA,OAAOA,KAAP,MAAkB,OAAlB;AACA,OAAOC,QAAP,MAAqB,kBAArB;AACA,OAAOC,kBAAP,MAA+B,kBAA/B;AACA,OAAOC,WAAP,MAAwB,aAAxB;AAEA,SAASC,mBAAT,EAA8BC,kBAA9B,QAAwD,QAAxD;AACA,OAAOC,iBAAP,MAA8B,oBAA9B;AACA,OAAOC,KAAP,MAAkB,UAAlB;AACA,SAASC,cAAT,EAAyBC,aAAzB,QAA8C,aAA9C;AACA,OAAOC,WAAP,MAAwB,wBAAxB;AACA,SAASC,UAAU,IAAIC,eAAvB,QAA8C,wBAA9C;AACA,SAASC,sBAAT,EAAiCC,SAAjC,EAA4CC,mCAA5C,QAAuF,cAAvF;AAEA;AAAA;AAAA;;;;;2BAAe,iBAAeC,QAAf;AAAA,oRAkDLC,iBAlDK;;AAAA;AAAA;AAAA;AAAA;AAkDLA,YAAAA,iBAlDK,kBAkDaC,IAlDb,EAkDmB;AAChC;AADgC,kBAE1BC,IAF0B,GAEGC,IAFH,CAE1BD,IAF0B;AAAA,kBAEpBE,SAFoB,GAEGD,IAFH,CAEpBC,SAFoB;AAAA,kBAETC,OAFS,GAEGF,IAFH,CAETE,OAFS,EAIhC;;AACAH,cAAAA,IAAI,GAAG,OAAOA,IAAP,KAAgB,UAAhB,GAA6BA,IAAI,CAACI,IAAD,EAAOC,UAAP,CAAjC,GAAsDL,IAA7D;AACAE,cAAAA,SAAS,GAAG,OAAOA,SAAP,KAAqB,UAArB,GAAkCA,SAAS,CAACE,IAAD,EAAOC,UAAP,CAA3C,GAAgEH,SAA5E;AACAC,cAAAA,OAAO,GAAG,OAAOA,OAAP,KAAmB,UAAnB,GAAgCA,OAAO,CAACC,IAAD,EAAOC,UAAP,CAAvC,GAA4DF,OAAtE,CAPgC,CAShC;;AACAG,cAAAA,MAAM,GAAG,OAAOA,MAAP,KAAkB,UAAlB,GAA+BA,MAAM,CAACF,IAAD,EAAOC,UAAP,CAArC,GAA0DC,MAAnE;;AAEA,kBAAI,CAACA,MAAM,CAACC,OAAZ,EAAqB;AACpB;AACA,oBAAID,MAAM,CAACE,UAAP,IAAqBF,MAAM,CAACE,UAAP,CAAkBC,IAA3C,EAAiD;AAChDH,kBAAAA,MAAM,CAACC,OAAP,GAAiB,CAAC,MAAD,CAAjB;AACA,iBAFD,MAEO;AACN,wBAAM,IAAIG,KAAJ,2cAAN;AACA;AACD,eAnB+B,CAqBhC;;;AACA,kBAAMC,aAAa,GAAG1B,mBAAmB,CAAC;AACzCqB,gBAAAA,MAAM,EAANA,MADyC;AAEzCM,gBAAAA,MAAM,EAAEb,IAAI,CAACa,MAAL,IAAehB,mCAAmC,CAACG,IAAI,CAACa,MAAN,CAFjB;AAGzCb,gBAAAA,IAAI,EAAEL,sBAAsB,CAACK,IAAD,CAAtB,CAA6Bc,IAA7B,CAAkC,EAAlC,CAHmC;AAIzCb,gBAAAA,IAAI,EAAJA,IAJyC;AAKzCE,gBAAAA,SAAS,EAATA;AALyC,eAAD,CAAzC,CAtBgC,CA8BhC;;AACA,kBAAMY,YAAY,GAAG5B,kBAAkB,CAAC;AACvCsB,gBAAAA,UAAU,EAAEO,kBAAkB,EADS;AAEvCT,gBAAAA,MAAM,EAANA,MAFuC;AAGvCU,gBAAAA,OAAO,EAAPA,OAHuC;AAIvCb,gBAAAA,OAAO,EAAPA,OAJuC;AAKvCc,gBAAAA,gBAAgB,EAAhBA,gBALuC;AAMvCC,gBAAAA,kBAAkB,EAAEC,aAAa,KAAK;AANC,eAAD,CAAvC;AASA,qBAAO,CAAER,aAAF,EAAiBG,YAAjB,CAAP;AACA,aA3Fa;;AACdR,YAAAA,MADc,QACdA,MADc,EAEdc,KAFc,QAEdA,KAFc,EAGdC,GAHc,QAGdA,GAHc,EAIdF,aAJc,QAIdA,aAJc,mBAKdlB,IALc,EAKdA,IALc,0BAKP,EALO,cAMdqB,OANc,QAMdA,OANc,EAOdN,OAPc,QAOdA,OAPc,EAQdO,OARc,QAQdA,OARc,EASdC,eATc,QASdA,eATc;AAWd3B,YAAAA,QAAQ,GAAGV,iBAAiB,CAACU,QAAD,CAA5B;AAXc,wBAoBVA,QApBU,EAcb4B,MAda,aAcbA,MAda,EAebC,SAfa,aAebA,SAfa,EAgBPC,WAhBO,aAgBb5B,IAhBa,EAiBb6B,cAjBa,aAiBbA,cAjBa,EAkBbC,OAlBa,aAkBbA,OAlBa,EAmBbC,SAnBa,aAmBbA,SAnBa;AAsBRC,YAAAA,QAtBQ,GAsBGzC,aAAa,CAAC+B,GAAD,CAtBhB;AAuBRjB,YAAAA,IAvBQ,GAuBD2B,QAAQ,CAACC,QAAT,CAAkBC,OAAlB,CAA0B,KAA1B,EAAiC,EAAjC,CAvBC,EAyBd;AACA;;AACIhB,YAAAA,gBA3BU,GA2BS,IA3BT;;AA4Bd,gBAAIb,IAAI,KAAK,mBAAb,EAAkC;AACjCa,cAAAA,gBAAgB,GAAG,KAAnB;AACA,aA9Ba,CAgCd;AACA;;;AACMiB,YAAAA,MAlCQ,GAkCC3C,WAlCD,EAoCd;;AApCc;AAAA,mBAyCJE,eAAe,CAACI,QAAD,EAAW;AACnCuB,cAAAA,KAAK,EAALA,KADmC;AAEnCE,cAAAA,OAAO,EAAPA,OAFmC;AAGnCC,cAAAA,OAAO,EAAPA,OAHmC;AAInCP,cAAAA,OAAO,EAAPA,OAJmC;AAKnCK,cAAAA,GAAG,EAAHA,GALmC;AAMnCG,cAAAA,eAAe,EAAfA;AANmC,aAAX,CAzCX;;AAAA;AAAA;AAsCJW,YAAAA,UAtCI,SAsCbb,OAtCa;AAuCbP,YAAAA,kBAvCa,SAuCbA,kBAvCa;AAwCVV,YAAAA,UAxCU;;AAAA,gBA+FTY,gBA/FS;AAAA;AAAA;AAAA;;AAgGb;AAhGa,iCAiG2BnB,iBAAiB,mBACrD6B,WADqD,MAErDhC,SAAS,CAAC,EAAD,CAF4C,EAjG5C,+DAiGLgB,cAjGK,2BAiGUG,aAjGV;AAAA,6CAqGN;AACNsB,cAAAA,KAAK,EAAE,mBADD;AAENC,cAAAA,MAAM,EAAE,GAFF;AAGNC,cAAAA,OAAO,EAAEvD,kBAAkB,CAAC4B,cAAa,GAAGG,aAAjB,CAHrB;AAINQ,cAAAA,OAAO,EAAE;AAJH,aArGM;;AAAA;AAAA;AAAA,mBAsHJY,MAAM,mBACZ7B,UADY;AAEf;AACAyB,cAAAA,SAAS,EAATA,SAHe;AAIfH,cAAAA,WAAW,EAAXA;AAJe,eAtHF;;AAAA;AAAA;AA+GbY,YAAAA,QA/Ga,SA+GbA,QA/Ga;AAgHbH,YAAAA,KAhHa,SAgHbA,KAhHa;AAiHbC,YAAAA,MAjHa,SAiHbA,MAjHa;AAkHbC,YAAAA,OAlHa,SAkHbA,OAlHa;AAmHbvC,YAAAA,IAnHa,SAmHbA,IAnHa;AAoHbyC,YAAAA,cApHa,SAoHbA,cApHa;AAqHbC,YAAAA,IArHa,SAqHbA,IArHa;;AAAA,iBA6HVF,QA7HU;AAAA;AAAA;AAAA;;AAAA,6CA8HN;AACN;AACA;AACAA,cAAAA,QAAQ,EAAElD,cAAc,CAACkD,QAAD,EAAW;AAAEG,gBAAAA,QAAQ,EAAE7C,QAAQ,CAAC6C;AAArB,eAAX;AAHlB,aA9HM;;AAAA;AAAA,kCAqI0B5C,iBAAiB,CAACC,IAAD,CArI3C,gEAqINY,aArIM,2BAqISG,YArIT;AAuIR6B,YAAAA,OAvIQ,GAuIE,CACf5D,kBAAkB,CAAC4B,aAAD,CADH,EAEf5B,kBAAkB,CAAC+B,YAAD,CAFH,CAvIF;;AA4Id,gBAAIK,aAAa,KAAK,KAAtB,EAA6B;AAC5B;AACA;AACA;AACMyB,cAAAA,WAJsB,GAIR/D,KAAK,CAACgE,aAAN,CAAoBnB,SAApB,EAA+Bc,cAA/B,EAA+CF,OAA/C,CAJQ;AAK5BK,cAAAA,OAAO,CAACG,MAAR,CAAeH,OAAO,CAACI,MAAR,GAAiB,CAAhC,EAAmC,CAAnC,EAAsCjE,QAAQ,CAACkE,kBAAT,CAA4BJ,WAA5B,CAAtC;AACA;;AAlJa,6CAoJP;AACNR,cAAAA,KAAK,EAALA,KADM;AAENC,cAAAA,MAAM,EAANA,MAFM;AAGNC,cAAAA,OAAO,EAAE,IAAItD,WAAJ,CAAgB2D,OAAhB,CAHH;AAINF,cAAAA,IAAI,EAAJA,IAJM;AAKNnB,cAAAA,OAAO,EAAEa;AALH,aApJO;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G","sourcesContent":["import React from 'react'\r\nimport ReactDOM from 'react-dom/server'\r\nimport createStringStream from 'string-to-stream'\r\nimport MultiStream from 'multistream'\r\n\r\nimport { renderBeforeContent, renderAfterContent } from './html'\r\nimport normalizeSettings from '../redux/normalize'\r\nimport timer from '../timer'\r\nimport { getLocationUrl, parseLocation } from '../location'\r\nimport reduxRender from '../redux/server/render'\r\nimport { initialize as reduxInitialize } from '../redux/server/server'\r\nimport { generateMetaTagsMarkup, mergeMeta, convertOpenGraphLocaleToLanguageTag } from '../meta/meta'\r\n\r\nexport default async function(settings, {\r\n\tassets,\r\n\tproxy,\r\n\turl,\r\n\trenderContent,\r\n\thtml = {},\r\n\tcookies,\r\n\tlocales,\r\n\theaders,\r\n\tgetInitialState\r\n}) {\r\n\tsettings = normalizeSettings(settings)\r\n\r\n\tconst {\r\n\t\troutes,\r\n\t\tcontainer,\r\n\t\tmeta: defaultMeta,\r\n\t\tauthentication,\r\n\t\tonError,\r\n\t\tcodeSplit\r\n\t} = settings\r\n\r\n\tconst location = parseLocation(url)\r\n\tconst path = location.pathname.replace(/\\/$/, '')\r\n\r\n\t// A special `base.html` page for static sites.\r\n\t// (e.g. the ones hosted on Amazon S3)\r\n\tlet serverSideRender = true\r\n\tif (path === '/react-pages-base') {\r\n\t\tserverSideRender = false\r\n\t}\r\n\r\n\t// If Redux is being used, then render for Redux.\r\n\t// Else render for pure React.\r\n\tconst render = reduxRender\r\n\r\n\t// `parameters` are used for `assets` and `html` modifiers.\r\n\tconst {\r\n\t\tcookies: newCookies,\r\n\t\tgenerateJavascript,\r\n\t\t...parameters\r\n\t} = await reduxInitialize(settings, {\r\n\t\tproxy,\r\n\t\tcookies,\r\n\t\theaders,\r\n\t\tlocales,\r\n\t\turl,\r\n\t\tgetInitialState\r\n\t})\r\n\r\n\tfunction generateOuterHtml(meta) {\r\n\t\t// `html` modifiers\r\n\t\tlet { head, bodyStart, bodyEnd } = html\r\n\r\n\t\t// Normalize `html` parameters\r\n\t\thead = typeof head === 'function' ? head(path, parameters) : head\r\n\t\tbodyStart = typeof bodyStart === 'function' ? bodyStart(path, parameters) : bodyStart\r\n\t\tbodyEnd = typeof bodyEnd === 'function' ? bodyEnd(path, parameters) : bodyEnd\r\n\r\n\t\t// Normalize assets\r\n\t\tassets = typeof assets === 'function' ? assets(path, parameters) : assets\r\n\r\n\t\tif (!assets.entries) {\r\n\t\t\t// Default `assets.entries` to `[\"main\"]`.\r\n\t\t\tif (assets.javascript && assets.javascript.main) {\r\n\t\t\t\tassets.entries = ['main']\r\n\t\t\t} else {\r\n\t\t\t\tthrow new Error(`\"assets.entries[]\" configuration parameter is required: it includes all Webpack \"entries\" for which javascripts and styles must be included on a server-rendered page. If you didn't set up any custom \"entries\" in Webpack configuration then the default Webpack entry is called \"main\". You don't seem to have the \"main\" entry so the server doesn't know which assets to include on the page (\"['main']\" is the default value for \"assets.entries\").`)\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Render all HTML that goes before React markup.\r\n\t\tconst beforeContent = renderBeforeContent({\r\n\t\t\tassets,\r\n\t\t\tlocale: meta.locale && convertOpenGraphLocaleToLanguageTag(meta.locale),\r\n\t\t\tmeta: generateMetaTagsMarkup(meta).join(''),\r\n\t\t\thead,\r\n\t\t\tbodyStart\r\n\t\t})\r\n\r\n\t\t// Render all HTML that goes after React markup\r\n\t\tconst afterContent = renderAfterContent({\r\n\t\t\tjavascript: generateJavascript(),\r\n\t\t\tassets,\r\n\t\t\tlocales,\r\n\t\t\tbodyEnd,\r\n\t\t\tserverSideRender,\r\n\t\t\tcontentNotRendered: renderContent === false\r\n\t\t})\r\n\r\n\t\treturn [ beforeContent, afterContent ]\r\n\t}\r\n\r\n\t// A special `base.html` page for static sites.\r\n\t// (e.g. the ones hosted on Amazon S3)\r\n\tif (!serverSideRender) {\r\n\t\t// Get `<meta/>` for the route.\r\n\t\tconst [ beforeContent, afterContent ] = generateOuterHtml({\r\n\t\t\t...defaultMeta,\r\n\t\t\t...mergeMeta([])\r\n\t\t})\r\n\t\treturn {\r\n\t\t\troute: '/react-pages-base',\r\n\t\t\tstatus: 200,\r\n\t\t\tcontent: createStringStream(beforeContent + afterContent),\r\n\t\t\tcookies: []\r\n\t\t}\r\n\t}\r\n\r\n\t// Render the page.\r\n\tconst {\r\n\t\tredirect,\r\n\t\troute,\r\n\t\tstatus,\r\n\t\tcontent,\r\n\t\tmeta,\r\n\t\tcontainerProps,\r\n\t\ttime\r\n\t} = await render({\r\n\t\t...parameters,\r\n\t\t// routes,\r\n\t\tcodeSplit,\r\n\t\tdefaultMeta\r\n\t})\r\n\r\n\tif (redirect) {\r\n\t\treturn {\r\n\t\t\t// Stringify `redirect` location.\r\n\t\t\t// Prepend `basename` to relative URLs for server-side redirect.\r\n\t\t\tredirect: getLocationUrl(redirect, { basename: settings.basename })\r\n\t\t}\r\n\t}\r\n\r\n\tconst [ beforeContent, afterContent ] = generateOuterHtml(meta)\r\n\r\n\tconst streams = [\r\n\t\tcreateStringStream(beforeContent),\r\n\t\tcreateStringStream(afterContent)\r\n\t]\r\n\r\n\tif (renderContent !== false) {\r\n\t\t// Render page content to a `Stream`\r\n\t\t// inserting this stream in the middle of `streams` array.\r\n\t\t// `array.splice(index, 0, element)` inserts `element` at `index`.\r\n\t\tconst pageElement = React.createElement(container, containerProps, content)\r\n\t\tstreams.splice(streams.length / 2, 0, ReactDOM.renderToNodeStream(pageElement))\r\n\t}\r\n\r\n\treturn {\r\n\t\troute,\r\n\t\tstatus,\r\n\t\tcontent: new MultiStream(streams),\r\n\t\ttime,\r\n\t\tcookies: newCookies\r\n\t}\r\n}"],"file":"render.js"}