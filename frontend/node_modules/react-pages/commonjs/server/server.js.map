{"version":3,"sources":["../../source/server/server.js"],"names":["server","settings","options","initialize","Error","secure","https","http","createServer","request","response","respondWithPage","error","respondWithError","printError","renderPage","url","headers","redirect","cookies","status","content","writeHead","Location","end","cookie","setHeader","pipe","proxy","assets","authentication","renderContent","html","stats","getInitialState","parse","locales","route","time","newCookies","contentType"],"mappings":"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","sourcesContent":["import http from 'http'\r\nimport https from 'https'\r\nimport cookie from 'cookie'\r\n\r\nimport render from './render'\r\nimport renderError from './renderError'\r\nimport timer from '../timer'\r\nimport { getPreferredLocales } from './locale'\r\n\r\nexport default function server(settings, options)\r\n{\r\n\tif (options.initialize) {\r\n\t\tthrow new Error('[react-pages] \"initialize\" server-side parameter function was removed. Use a root-level `load` instead.')\r\n\t}\r\n\treturn (options.secure ? https : http).createServer((request, response) => {\r\n\t\t// Render the page (and handle errors, if any)\r\n\t\trespondWithPage(request, response, settings, options)\r\n\t\t\t.catch((error) => respondWithError(error, response, options.printError))\r\n\t})\r\n}\r\n\r\n// Renders a webpage\r\nasync function respondWithPage(request, response, settings, options)\r\n{\r\n\tconst {\r\n\t\tredirect,\r\n\t\tcookies,\r\n\t\tstatus,\r\n\t\tcontent\r\n\t} = await renderPage(request.url, request.headers, settings, options)\r\n\r\n\tif (redirect) {\r\n\t\tresponse.writeHead(302, { Location: redirect })\r\n\t\treturn response.end()\r\n\t}\r\n\r\n\t// `cookies` is a `Set`, not an `Array`,\r\n\t// hence the `for` loop.\r\n\tfor (const cookie of cookies) {\r\n\t\tresponse.setHeader('Set-Cookie', cookie)\r\n\t}\r\n\r\n\t// HTTP response status and \"Content-Type\"\r\n\tresponse.writeHead(status || 200, { 'Content-Type': 'text/html' })\r\n\r\n\t// Stream the rendered React page\r\n\tcontent.pipe(response)\r\n}\r\n\r\n// Renders a webpage.\r\n// `headers`: `{ cookie, accept-language, host, user-agent }`.\r\nexport async function renderPage(url, headers, settings, options)\r\n{\r\n\tconst {\r\n\t\tsecure,\r\n\t\tproxy,\r\n\t\tassets,\r\n\t\tauthentication,\r\n\t\trenderContent,\r\n\t\thtml,\r\n\t\tstats,\r\n\t\tgetInitialState\r\n\t} = options\r\n\r\n\tconst cookies = headers.cookie ? cookie.parse(headers.cookie) : {}\r\n\r\n\tlet {\r\n\t\tstatus,\r\n\t\tcontent,\r\n\t\tredirect,\r\n\t\troute,\r\n\t\ttime,\r\n\t\tcookies: newCookies\r\n\t} = await render(settings, {\r\n\t\tproxy,\r\n\t\tassets,\r\n\t\tauthentication,\r\n\t\trenderContent,\r\n\t\thtml,\r\n\t\turl,\r\n\t\t// Cookies for making `http` requests on server.\r\n\t\tcookies,\r\n\t\tlocales: getPreferredLocales(headers),\r\n\t\t// Headers are used in `getInitialState()`.\r\n\t\t// https://github.com/catamphetamine/react-website/issues/72\r\n\t\tgetInitialState,\r\n\t\theaders\r\n\t})\r\n\r\n\t// If a redirect happened perform an HTTP redirect\r\n\tif (redirect) {\r\n\t\t// No need to convert a relative URL to an absolute URL:\r\n\t\t// since June 2014 the RFC permits redirection to relative URLs.\r\n\t\t// https://stackoverflow.com/questions/8250259/is-a-302-redirect-to-relative-url-valid-or-invalid\r\n\t\t// // Convert relative URL to an absolute one\r\n\t\t// if (redirect[0] === '/') {\r\n\t\t// \tredirect = `${secure ? 'https' : 'http'}://${headers.host}${redirect}`;\r\n\t\t// }\r\n\t\treturn { redirect }\r\n\t}\r\n\r\n\t// Report page rendering stats\r\n\tif (stats) {\r\n\t\tstats({\r\n\t\t\turl,\r\n\t\t\troute,\r\n\t\t\ttime\r\n\t\t})\r\n\t}\r\n\r\n\treturn {\r\n\t\tcookies: newCookies,\r\n\t\tstatus,\r\n\t\tcontent\r\n\t}\r\n}\r\n\r\nfunction respondWithError(error, response, options)\r\n{\r\n\tconst { status, content, contentType } = renderError(error, options)\r\n\r\n\t// HTTP response status and \"Content-Type\"\r\n\tresponse.writeHead(status, { 'Content-Type': contentType })\r\n\r\n\t// Output the error page\r\n\treturn response.end(content)\r\n}"],"file":"server.js"}